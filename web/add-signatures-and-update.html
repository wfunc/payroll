<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·»åŠ ç­¾åå¹¶æ›´æ–°æŠ¥å‘Š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .step-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .step-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-item {
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            margin-right: 10px;
        }

        .signature-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .signature-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .signature-box h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .signature-canvas {
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: crosshair;
            background: white;
            display: block;
            margin: 0 auto;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin: 5px;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-info {
            background: #bee3f8;
            color: #2c5282;
        }

        .status-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .log {
            background: #1a202c;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .button-group {
            text-align: center;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>âœï¸ æ·»åŠ ç­¾åå¹¶æ›´æ–°æŠ¥å‘Š</h1>

        <div class="alert alert-info">
            <strong>è¯´æ˜ï¼š</strong>æ­¤å·¥å…·ç”¨äºä¸ºç¦»èŒç”³è¯·æ·»åŠ ç”µå­ç­¾åï¼Œç„¶åé‡æ–°ç”ŸæˆæŠ¥å‘Šä»¥æ˜¾ç¤ºç­¾åå†…å®¹ã€‚
        </div>

        <!-- Step 1: é€‰æ‹©ç”³è¯· -->
        <div class="step-section">
            <h2><span class="step-number">1</span>é€‰æ‹©ç¦»èŒç”³è¯·</h2>
            <div class="info-grid">
                <div class="info-item">
                    <label class="info-label">ç¦»èŒç”³è¯·ï¼š</label>
                    <select id="applicationSelect" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadApplications()">åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div class="info-item" id="applicationInfo" style="display: none;">
                    <p><span class="info-label">å‘˜å·¥ï¼š</span><span id="employeeName">-</span></p>
                    <p><span class="info-label">éƒ¨é—¨ï¼š</span><span id="department">-</span></p>
                    <p><span class="info-label">çŠ¶æ€ï¼š</span><span id="applicationStatus">-</span></p>
                </div>
            </div>
        </div>

        <!-- Step 2: æ£€æŸ¥ç­¾åçŠ¶æ€ -->
        <div class="step-section">
            <h2><span class="step-number">2</span>å½“å‰ç­¾åçŠ¶æ€</h2>
            <div id="signatureStatus">
                <p style="color: #999; text-align: center;">è¯·å…ˆé€‰æ‹©ç¦»èŒç”³è¯·</p>
            </div>
        </div>

        <!-- Step 3: æ·»åŠ ç­¾å -->
        <div class="step-section">
            <h2><span class="step-number">3</span>æ·»åŠ ç”µå­ç­¾å</h2>
            <div class="signature-container">
                <!-- å‘˜å·¥ç­¾å -->
                <div class="signature-box">
                    <h3>å‘˜å·¥æœ¬äººç­¾å</h3>
                    <canvas id="employeeCanvas" class="signature-canvas" width="280" height="150"></canvas>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-warning" onclick="clearCanvas('employeeCanvas')">æ¸…é™¤</button>
                        <button class="btn btn-primary" onclick="autoSign('employeeCanvas', 'ç‹äº”')">è‡ªåŠ¨ç­¾å</button>
                        <button class="btn btn-success" onclick="submitSignature('employee')">æäº¤</button>
                    </div>
                    <div id="employeeStatus"></div>
                </div>

                <!-- HRç­¾å -->
                <div class="signature-box">
                    <h3>äººåŠ›èµ„æºéƒ¨ç­¾å</h3>
                    <canvas id="hrCanvas" class="signature-canvas" width="280" height="150"></canvas>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-warning" onclick="clearCanvas('hrCanvas')">æ¸…é™¤</button>
                        <button class="btn btn-primary" onclick="autoSign('hrCanvas', 'HRå®¡æ ¸')">è‡ªåŠ¨ç­¾å</button>
                        <button class="btn btn-success" onclick="submitSignature('hr')">æäº¤</button>
                    </div>
                    <div id="hrStatus"></div>
                </div>

                <!-- ä¸»ç®¡ç­¾å -->
                <div class="signature-box">
                    <h3>éƒ¨é—¨ä¸»ç®¡ç­¾å</h3>
                    <canvas id="managerCanvas" class="signature-canvas" width="280" height="150"></canvas>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-warning" onclick="clearCanvas('managerCanvas')">æ¸…é™¤</button>
                        <button class="btn btn-primary" onclick="autoSign('managerCanvas', 'éƒ¨é—¨ä¸»ç®¡')">è‡ªåŠ¨ç­¾å</button>
                        <button class="btn btn-success" onclick="submitSignature('manager')">æäº¤</button>
                    </div>
                    <div id="managerStatus"></div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-success" onclick="submitAllSignatures()"
                    style="font-size: 16px; padding: 12px 30px;">
                    âœ… ä¸€é”®æ·»åŠ æ‰€æœ‰ç­¾å
                </button>
            </div>
        </div>

        <!-- Step 4: æ›´æ–°æŠ¥å‘Š -->
        <div class="step-section">
            <h2><span class="step-number">4</span>æ›´æ–°æŠ¥å‘Š</h2>
            <div class="button-group">
                <button class="btn btn-primary" onclick="regenerateReport()" id="regenerateBtn"
                    style="font-size: 16px; padding: 12px 30px;">
                    ğŸ”„ é‡æ–°ç”ŸæˆæŠ¥å‘Šï¼ˆåŒ…å«ç­¾åï¼‰
                </button>
                <button class="btn btn-success" onclick="viewReport()" id="viewReportBtn"
                    style="display: none; font-size: 16px; padding: 12px 30px;">
                    ğŸ“‹ æŸ¥çœ‹æ–°æŠ¥å‘Š
                </button>
            </div>
            <div id="reportResult"></div>
        </div>

        <!-- æ“ä½œæ—¥å¿— -->
        <div class="step-section">
            <h2>ğŸ“œ æ“ä½œæ—¥å¿—</h2>
            <div class="log" id="logContainer"></div>
        </div>
    </div>

    <script>
        const apiUrl = '/api/v1';
        const adminToken = localStorage.getItem('adminToken');
        let selectedApplication = null;
        let currentReportId = null;
        let newReportId = null;
        const canvasContexts = {};
        const isDrawing = {};

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#fc8181' : type === 'success' ? '#68d391' : '#63b3ed';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // åˆå§‹åŒ–ç”»å¸ƒ
        function initCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            canvasContexts[canvasId] = ctx;
            isDrawing[canvasId] = false;

            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';

            // é¼ æ ‡äº‹ä»¶
            canvas.addEventListener('mousedown', (e) => startDrawing(e, canvasId));
            canvas.addEventListener('mousemove', (e) => draw(e, canvasId));
            canvas.addEventListener('mouseup', () => stopDrawing(canvasId));
            canvas.addEventListener('mouseout', () => stopDrawing(canvasId));

            // è§¦æ‘¸äº‹ä»¶
            canvas.addEventListener('touchstart', (e) => handleTouch(e, canvasId, 'start'));
            canvas.addEventListener('touchmove', (e) => handleTouch(e, canvasId, 'move'));
            canvas.addEventListener('touchend', () => stopDrawing(canvasId));
        }

        function startDrawing(e, canvasId) {
            isDrawing[canvasId] = true;
            const canvas = document.getElementById(canvasId);
            const rect = canvas.getBoundingClientRect();
            const ctx = canvasContexts[canvasId];
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e, canvasId) {
            if (!isDrawing[canvasId]) return;
            const canvas = document.getElementById(canvasId);
            const rect = canvas.getBoundingClientRect();
            const ctx = canvasContexts[canvasId];
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDrawing(canvasId) {
            isDrawing[canvasId] = false;
        }

        function handleTouch(e, canvasId, type) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(
                type === 'start' ? 'mousedown' : 'mousemove',
                {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                }
            );
            document.getElementById(canvasId).dispatchEvent(mouseEvent);
        }

        // æ¸…é™¤ç”»å¸ƒ
        function clearCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvasContexts[canvasId];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            log(`æ¸…é™¤äº† ${canvasId} ç”»å¸ƒ`);
        }

        // è‡ªåŠ¨ç­¾å
        function autoSign(canvasId, text) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvasContexts[canvasId];

            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // è®¾ç½®ç­¾åæ ·å¼
            ctx.fillStyle = 'black';
            ctx.font = 'italic 30px cursive';
            ctx.fillText(text, 50, 80);

            // æ·»åŠ è£…é¥°çº¿
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, 100);
            ctx.quadraticCurveTo(140, 70, 240, 100);
            ctx.stroke();

            log(`è‡ªåŠ¨ç”Ÿæˆäº† ${text} çš„ç­¾å`);
        }

        // åŠ è½½ç”³è¯·åˆ—è¡¨
        async function loadApplications() {
            try {
                log('åŠ è½½ç¦»èŒç”³è¯·åˆ—è¡¨...');
                const response = await fetch(`${apiUrl}/resignations`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

                const data = await response.json();
                const select = document.getElementById('applicationSelect');

                if (data.data && data.data.length > 0) {
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    data.data.forEach(app => {
                        select.innerHTML += `
                            <option value="${app.uuid}">
                                ${app.employee?.name || 'æœªçŸ¥'} - ${app.employee?.department || 'æœªçŸ¥éƒ¨é—¨'} - ${app.status}
                            </option>
                        `;
                    });
                    log(`åŠ è½½äº† ${data.data.length} ä¸ªç¦»èŒç”³è¯·`, 'success');

                    // é»˜è®¤é€‰æ‹©IDä¸º7çš„ç”³è¯·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const defaultApp = data.data.find(app => app.id === 7);
                    if (defaultApp) {
                        select.value = defaultApp.uuid;
                        await selectApplication();
                    }
                } else {
                    select.innerHTML = '<option value="">æš‚æ— ç¦»èŒç”³è¯·</option>';
                    log('æš‚æ— ç¦»èŒç”³è¯·', 'info');
                }
            } catch (error) {
                log('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é€‰æ‹©ç”³è¯·
        async function selectApplication() {
            const uuid = document.getElementById('applicationSelect').value;
            if (!uuid) return;

            try {
                log(`åŠ è½½ç”³è¯·è¯¦æƒ…: ${uuid}`);
                const response = await fetch(`${apiUrl}/resignations/${uuid}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

                const data = await response.json();
                selectedApplication = data.data;

                // æ˜¾ç¤ºç”³è¯·ä¿¡æ¯
                document.getElementById('applicationInfo').style.display = 'block';
                document.getElementById('employeeName').textContent = selectedApplication.employee?.name || '-';
                document.getElementById('department').textContent = selectedApplication.employee?.department || '-';
                document.getElementById('applicationStatus').innerHTML =
                    `<span class="status status-${selectedApplication.status === 'approved' ? 'success' : 'info'}">${selectedApplication.status}</span>`;

                // æ£€æŸ¥ç­¾åçŠ¶æ€
                await checkSignatureStatus();

                // æŸ¥æ‰¾ç›¸å…³æŠ¥å‘Š
                await findRelatedReport();

            } catch (error) {
                log('åŠ è½½ç”³è¯·å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥ç­¾åçŠ¶æ€
        async function checkSignatureStatus() {
            if (!selectedApplication) return;

            try {
                const response = await fetch(`${apiUrl}/resignations/${selectedApplication.uuid}/signatures`);
                if (!response.ok) throw new Error('è·å–ç­¾åå¤±è´¥');

                const data = await response.json();
                const signatures = data.data || [];

                const signerTypes = ['employee', 'hr', 'manager'];
                const typeNames = {
                    'employee': 'å‘˜å·¥æœ¬äºº',
                    'hr': 'äººåŠ›èµ„æºéƒ¨',
                    'manager': 'éƒ¨é—¨ä¸»ç®¡'
                };

                let statusHTML = '<div style="display: flex; justify-content: space-around; flex-wrap: wrap;">';

                signerTypes.forEach(type => {
                    const signed = signatures.find(s => s.signer_type === type);
                    if (signed) {
                        statusHTML += `<span class="status status-success">${typeNames[type]}: âœ… å·²ç­¾å</span>`;
                        document.getElementById(`${type}Status`).innerHTML =
                            '<span class="status status-success">âœ… å·²ç­¾å</span>';
                    } else {
                        statusHTML += `<span class="status status-warning">${typeNames[type]}: â³ å¾…ç­¾å</span>`;
                        document.getElementById(`${type}Status`).innerHTML =
                            '<span class="status status-warning">â³ å¾…ç­¾å</span>';
                    }
                });

                statusHTML += '</div>';
                document.getElementById('signatureStatus').innerHTML = statusHTML;

                log(`ç­¾åçŠ¶æ€: ${signatures.length}/3 å·²å®Œæˆ`, 'info');

            } catch (error) {
                log('è·å–ç­¾åçŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æŸ¥æ‰¾ç›¸å…³æŠ¥å‘Š
        async function findRelatedReport() {
            if (!selectedApplication) return;

            try {
                const response = await fetch(`${apiUrl}/resignation-reports`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (!response.ok) throw new Error('è·å–æŠ¥å‘Šåˆ—è¡¨å¤±è´¥');

                const data = await response.json();
                const reports = data.data || [];

                // æŸ¥æ‰¾ä¸å½“å‰ç”³è¯·ç›¸å…³çš„æŠ¥å‘Š
                const relatedReport = reports.find(r => r.application_id === selectedApplication.id);

                if (relatedReport) {
                    currentReportId = relatedReport.id;
                    log(`æ‰¾åˆ°ç›¸å…³æŠ¥å‘Š ID: ${currentReportId}`, 'info');
                    document.getElementById('reportResult').innerHTML =
                        `<div class="alert alert-info">å½“å‰æŠ¥å‘Š ID: ${currentReportId}</div>`;
                } else {
                    log('æœªæ‰¾åˆ°ç›¸å…³æŠ¥å‘Šï¼Œéœ€è¦å…ˆåˆ›å»ºæŠ¥å‘Š', 'warning');
                    document.getElementById('reportResult').innerHTML =
                        '<div class="alert alert-warning">æœªæ‰¾åˆ°ç›¸å…³æŠ¥å‘Šï¼Œå°†åˆ›å»ºæ–°æŠ¥å‘Š</div>';
                }

            } catch (error) {
                log('æŸ¥æ‰¾æŠ¥å‘Šå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æäº¤ç­¾å
        async function submitSignature(signerType) {
            if (!selectedApplication) {
                alert('è¯·å…ˆé€‰æ‹©ç¦»èŒç”³è¯·');
                return;
            }

            const canvasId = signerType + 'Canvas';
            const canvas = document.getElementById(canvasId);
            const signatureData = canvas.toDataURL();

            try {
                log(`æäº¤ ${signerType} ç­¾å...`);

                const response = await fetch(`${apiUrl}/resignations/sign`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        application_id: selectedApplication.uuid,
                        signer_type: signerType,
                        signature_data: signatureData,
                        device_info: 'Signature Tool'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ç­¾åå¤±è´¥');
                }

                log(`${signerType} ç­¾åæäº¤æˆåŠŸï¼`, 'success');
                document.getElementById(`${signerType}Status`).innerHTML =
                    '<span class="status status-success">âœ… å·²ç­¾å</span>';

                // åˆ·æ–°ç­¾åçŠ¶æ€
                await checkSignatureStatus();

            } catch (error) {
                log(`${signerType} ç­¾åå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¸€é”®æ·»åŠ æ‰€æœ‰ç­¾å
        async function submitAllSignatures() {
            if (!selectedApplication) {
                alert('è¯·å…ˆé€‰æ‹©ç¦»èŒç”³è¯·');
                return;
            }

            log('å¼€å§‹æ‰¹é‡æ·»åŠ ç­¾å...', 'info');

            // è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰ç­¾å
            autoSign('employeeCanvas', selectedApplication.employee?.name || 'å‘˜å·¥');
            autoSign('hrCanvas', 'HRå®¡æ ¸');
            autoSign('managerCanvas', 'éƒ¨é—¨ä¸»ç®¡');

            // æäº¤æ‰€æœ‰ç­¾å
            await submitSignature('employee');
            await submitSignature('hr');
            await submitSignature('manager');

            log('æ‰€æœ‰ç­¾åæ·»åŠ å®Œæˆï¼', 'success');
        }

        // é‡æ–°ç”ŸæˆæŠ¥å‘Š
        async function regenerateReport() {
            if (!selectedApplication) {
                alert('è¯·å…ˆé€‰æ‹©ç¦»èŒç”³è¯·');
                return;
            }

            const btn = document.getElementById('regenerateBtn');
            btn.disabled = true;
            btn.textContent = 'â³ æ­£åœ¨ç”Ÿæˆ...';

            try {
                log('å¼€å§‹é‡æ–°ç”ŸæˆæŠ¥å‘Š...');

                // å¦‚æœæœ‰æ—§æŠ¥å‘Šï¼Œå…ˆåˆ é™¤
                if (currentReportId) {
                    log(`åˆ é™¤æ—§æŠ¥å‘Š ID: ${currentReportId}`);
                    await fetch(`${apiUrl}/resignation-reports/${currentReportId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });
                }

                // åˆ›å»ºæ–°æŠ¥å‘Š
                log('åˆ›å»ºæ–°æŠ¥å‘Š...');
                const response = await fetch(`${apiUrl}/resignation-reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        application_id: selectedApplication.id,
                        work_summary: 'å®Œæˆäº†æ‰€æœ‰å·¥ä½œä»»åŠ¡ï¼Œé¡¹ç›®æ–‡æ¡£å·²æ•´ç†å®Œæ¯•',
                        unfinished_tasks: 'æ‰€æœ‰ä»»åŠ¡å·²äº¤æ¥ç»™å›¢é˜Ÿå…¶ä»–æˆå‘˜',
                        company_property_returned: true,
                        financial_settlement: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'åˆ›å»ºæŠ¥å‘Šå¤±è´¥');
                }

                const result = await response.json();
                newReportId = result.data.id;

                log(`âœ… æ–°æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼ID: ${newReportId}`, 'success');

                document.getElementById('reportResult').innerHTML =
                    `<div class="alert alert-success">
                        <strong>æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼</strong><br>
                        æ–°æŠ¥å‘Š ID: ${newReportId}<br>
                        æŠ¥å‘Šç°åœ¨åŒ…å«äº†æ‰€æœ‰ç­¾åä¿¡æ¯
                    </div>`;

                document.getElementById('viewReportBtn').style.display = 'inline-block';
                btn.textContent = 'âœ… ç”Ÿæˆå®Œæˆ';

            } catch (error) {
                log('ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ é‡æ–°ç”ŸæˆæŠ¥å‘Š';
            }
        }

        // æŸ¥çœ‹æŠ¥å‘Š
        async function viewReport() {
            const reportId = newReportId || currentReportId;
            if (!reportId) {
                alert('æ²¡æœ‰å¯æŸ¥çœ‹çš„æŠ¥å‘Š');
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/resignation-reports/${reportId}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (!response.ok) throw new Error('è·å–æŠ¥å‘Šå¤±è´¥');

                const data = await response.json();
                const report = data.data;

                if (report.report_content) {
                    const reportWindow = window.open('', '_blank', 'width=900,height=700');
                    reportWindow.document.write(report.report_content);
                    reportWindow.document.close();
                    log('æŠ¥å‘Šå·²åœ¨æ–°çª—å£æ‰“å¼€', 'success');
                }

            } catch (error) {
                log('æŸ¥çœ‹æŠ¥å‘Šå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function () {
            if (!adminToken) {
                log('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç®¡ç†ç³»ç»Ÿ', 'error');
                setTimeout(() => {
                    window.location.href = '/web/login.html';
                }, 2000);
                return;
            }

            // åˆå§‹åŒ–æ‰€æœ‰ç”»å¸ƒ
            initCanvas('employeeCanvas');
            initCanvas('hrCanvas');
            initCanvas('managerCanvas');

            // ç»‘å®šé€‰æ‹©äº‹ä»¶
            document.getElementById('applicationSelect').addEventListener('change', selectApplication);

            // åŠ è½½ç”³è¯·åˆ—è¡¨
            loadApplications();

            log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡æ–°ç”Ÿæˆç¦»èŒæŠ¥å‘Š</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .warning {
            background: #fff5f5;
            border: 2px solid #feb2b2;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .warning h3 {
            color: #c53030;
            margin-top: 0;
        }

        .section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .report-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-info {
            background: #bee3f8;
            color: #2c5282;
        }

        .status-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .log {
            background: #1a202c;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .progress {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .info-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”„ é‡æ–°ç”Ÿæˆç¦»èŒæŠ¥å‘Šå·¥å…·</h1>

        <div class="warning">
            <h3>âš ï¸ é‡è¦æç¤º</h3>
            <p>æ­¤å·¥å…·ç”¨äºé‡æ–°ç”Ÿæˆæ‰€æœ‰ç¦»èŒæŠ¥å‘Šï¼Œä½¿ç”¨æœ€æ–°çš„æŠ¥å‘Šæ ¼å¼ã€‚</p>
            <p>é‡æ–°ç”Ÿæˆå°†ï¼š</p>
            <ul>
                <li>åˆ é™¤ç°æœ‰æŠ¥å‘Šå†…å®¹</li>
                <li>ä½¿ç”¨æ–°çš„æ ¼å¼é‡æ–°ç”ŸæˆæŠ¥å‘Šï¼ˆåŒ…æ‹¬ä¸­æ–‡ç¦»èŒç±»å‹å’Œç­¾åæ˜¾ç¤ºï¼‰</li>
                <li>ä¿ç•™æ‰€æœ‰å…¶ä»–æ•°æ®ï¼ˆç”³è¯·ä¿¡æ¯ã€ç­¾åè®°å½•ç­‰ï¼‰</li>
            </ul>
        </div>

        <div class="section">
            <h2>ğŸ“Š å½“å‰æŠ¥å‘Šç»Ÿè®¡</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h4>æ€»æŠ¥å‘Šæ•°</h4>
                    <div class="value" id="totalReports">-</div>
                </div>
                <div class="info-card">
                    <h4>éœ€è¦æ›´æ–°</h4>
                    <div class="value" id="needUpdate">-</div>
                </div>
                <div class="info-card">
                    <h4>å·²æ›´æ–°</h4>
                    <div class="value" id="updated">0</div>
                </div>
                <div class="info-card">
                    <h4>æ›´æ–°å¤±è´¥</h4>
                    <div class="value" id="failed">0</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”§ æ“ä½œé€‰é¡¹</h2>
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="loadReports()">
                    ğŸ“‹ åŠ è½½æŠ¥å‘Šåˆ—è¡¨
                </button>
                <button class="btn btn-warning" onclick="regenerateAll()">
                    ğŸ”„ é‡æ–°ç”Ÿæˆæ‰€æœ‰æŠ¥å‘Š
                </button>
                <button class="btn btn-success" onclick="testNewFormat()">
                    ğŸ§ª æµ‹è¯•æ–°æ ¼å¼ï¼ˆåˆ›å»ºç¤ºä¾‹ï¼‰
                </button>
            </div>

            <div class="progress" style="display: none;" id="progressBar">
                <div class="progress-bar" id="progressBarFill" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ æŠ¥å‘Šåˆ—è¡¨</h2>
            <div id="reportsList"></div>
        </div>

        <div class="section">
            <h2>ğŸ“œ æ“ä½œæ—¥å¿—</h2>
            <div class="log" id="operationLog"></div>
        </div>
    </div>

    <script>
        const apiUrl = '/api/v1';
        const adminToken = localStorage.getItem('adminToken');
        let reports = [];
        let updatedCount = 0;
        let failedCount = 0;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#fc8181' : type === 'success' ? '#68d391' : '#63b3ed';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // åŠ è½½æŠ¥å‘Šåˆ—è¡¨
        async function loadReports() {
            try {
                log('æ­£åœ¨åŠ è½½æŠ¥å‘Šåˆ—è¡¨...');
                const response = await fetch(`${apiUrl}/resignation-reports`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

                const data = await response.json();
                reports = data.data || [];

                document.getElementById('totalReports').textContent = reports.length;
                document.getElementById('needUpdate').textContent = reports.length;

                displayReports(reports);
                log(`æˆåŠŸåŠ è½½ ${reports.length} ä¸ªæŠ¥å‘Š`, 'success');

            } catch (error) {
                log('åŠ è½½æŠ¥å‘Šå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæŠ¥å‘Šåˆ—è¡¨
        function displayReports(reportList) {
            const container = document.getElementById('reportsList');

            if (reportList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— æŠ¥å‘Š</p>';
                return;
            }

            container.innerHTML = reportList.map(report => `
                <div class="report-item">
                    <div>
                        <strong>${report.application?.employee?.name || 'æœªçŸ¥'}</strong> - 
                        ${report.application?.employee?.department || 'æœªçŸ¥éƒ¨é—¨'}
                        <span class="status status-info" style="margin-left: 10px;">
                            ID: ${report.id}
                        </span>
                        <span class="status status-warning" style="margin-left: 5px;">
                            å¾…æ›´æ–°
                        </span>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="regenerateOne(${report.id})">
                        é‡æ–°ç”Ÿæˆ
                    </button>
                </div>
            `).join('');
        }

        // é‡æ–°ç”Ÿæˆå•ä¸ªæŠ¥å‘Š
        async function regenerateOne(reportId) {
            try {
                log(`æ­£åœ¨é‡æ–°ç”ŸæˆæŠ¥å‘Š ID: ${reportId}...`);

                // è·å–æŠ¥å‘Šè¯¦æƒ…
                const reportResponse = await fetch(`${apiUrl}/resignation-reports/${reportId}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (!reportResponse.ok) throw new Error('è·å–æŠ¥å‘Šå¤±è´¥');
                const reportData = await reportResponse.json();
                const report = reportData.data;

                // åˆ é™¤æ—§æŠ¥å‘Š
                const deleteResponse = await fetch(`${apiUrl}/resignation-reports/${reportId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (!deleteResponse.ok) {
                    log(`æ— æ³•åˆ é™¤æ—§æŠ¥å‘Š ${reportId}ï¼Œå°è¯•ç›´æ¥æ›´æ–°`, 'warning');
                }

                // é‡æ–°åˆ›å»ºæŠ¥å‘Š
                const createResponse = await fetch(`${apiUrl}/resignation-reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        application_id: report.application_id,
                        work_summary: report.work_summary || 'å·¥ä½œæ€»ç»“å†…å®¹',
                        unfinished_tasks: report.unfinished_tasks || 'æœªå®Œæˆäº‹é¡¹',
                        company_property_returned: report.company_property_returned !== false,
                        financial_settlement: report.financial_settlement !== false
                    })
                });

                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error || 'åˆ›å»ºå¤±è´¥');
                }

                const newReport = await createResponse.json();
                log(`âœ… æŠ¥å‘Š ${reportId} é‡æ–°ç”ŸæˆæˆåŠŸï¼Œæ–°ID: ${newReport.data.id}`, 'success');

                updatedCount++;
                document.getElementById('updated').textContent = updatedCount;

                return true;

            } catch (error) {
                log(`âŒ é‡æ–°ç”ŸæˆæŠ¥å‘Š ${reportId} å¤±è´¥: ${error.message}`, 'error');
                failedCount++;
                document.getElementById('failed').textContent = failedCount;
                return false;
            }
        }

        // é‡æ–°ç”Ÿæˆæ‰€æœ‰æŠ¥å‘Š
        async function regenerateAll() {
            if (reports.length === 0) {
                alert('è¯·å…ˆåŠ è½½æŠ¥å‘Šåˆ—è¡¨');
                return;
            }

            if (!confirm(`ç¡®å®šè¦é‡æ–°ç”Ÿæˆæ‰€æœ‰ ${reports.length} ä¸ªæŠ¥å‘Šå—ï¼Ÿ`)) {
                return;
            }

            log('å¼€å§‹æ‰¹é‡é‡æ–°ç”ŸæˆæŠ¥å‘Š...', 'info');
            document.getElementById('progressBar').style.display = 'block';

            updatedCount = 0;
            failedCount = 0;

            for (let i = 0; i < reports.length; i++) {
                const report = reports[i];
                const progress = Math.round((i + 1) / reports.length * 100);

                document.getElementById('progressBarFill').style.width = progress + '%';
                document.getElementById('progressBarFill').textContent = progress + '%';

                await regenerateOne(report.id);

                // æ·»åŠ å»¶è¿Ÿï¼Œé¿å…æœåŠ¡å™¨è¿‡è½½
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            log(`æ‰¹é‡é‡æ–°ç”Ÿæˆå®Œæˆï¼æˆåŠŸ: ${updatedCount}, å¤±è´¥: ${failedCount}`, 'success');

            // é‡æ–°åŠ è½½åˆ—è¡¨
            setTimeout(() => {
                loadReports();
            }, 2000);
        }

        // æµ‹è¯•æ–°æ ¼å¼
        async function testNewFormat() {
            try {
                log('åˆ›å»ºæµ‹è¯•æ•°æ®...');

                // åˆ›å»ºæµ‹è¯•å‘˜å·¥
                const empResponse = await fetch(`${apiUrl}/employees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        name: 'æ ¼å¼æµ‹è¯•å‘˜å·¥_' + Date.now(),
                        employee_no: 'FORMAT_TEST_' + Date.now(),
                        department: 'æŠ€æœ¯éƒ¨',
                        position: 'å‰ç«¯å¼€å‘',
                        email: 'test@example.com',
                        phone: '13800138000',
                        join_date: '2020-01-01'
                    })
                });

                if (!empResponse.ok) throw new Error('åˆ›å»ºå‘˜å·¥å¤±è´¥');
                const empData = await empResponse.json();
                const employeeId = empData.data.id;
                log(`åˆ›å»ºæµ‹è¯•å‘˜å·¥æˆåŠŸï¼ŒID: ${employeeId}`, 'success');

                // åˆ›å»ºç¦»èŒç”³è¯·
                const resResponse = await fetch(`${apiUrl}/resignations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        employee_id: employeeId,
                        resignation_type: 'voluntary',
                        reason: 'æµ‹è¯•æ–°æ ¼å¼æ˜¾ç¤º',
                        last_working_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                    })
                });

                if (!resResponse.ok) throw new Error('åˆ›å»ºç”³è¯·å¤±è´¥');
                const resData = await resResponse.json();
                const applicationUuid = resData.data.uuid;
                const applicationId = resData.data.id;
                log(`åˆ›å»ºç¦»èŒç”³è¯·æˆåŠŸï¼ŒUUID: ${applicationUuid}`, 'success');

                // æ‰¹å‡†ç”³è¯·
                const approveResponse = await fetch(`${apiUrl}/resignations/${applicationUuid}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        approval_notes: 'æµ‹è¯•æ‰¹å‡†'
                    })
                });

                if (!approveResponse.ok) throw new Error('æ‰¹å‡†å¤±è´¥');
                log('ç¦»èŒç”³è¯·å·²æ‰¹å‡†', 'success');

                // æ·»åŠ æ¨¡æ‹Ÿç­¾å
                const signerTypes = ['employee', 'hr', 'manager'];
                for (const type of signerTypes) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 200;
                    canvas.height = 100;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'black';
                    ctx.font = '20px Arial';
                    ctx.fillText(`${type} ç­¾å`, 50, 50);
                    const signatureData = canvas.toDataURL();

                    const signResponse = await fetch(`${apiUrl}/resignations/sign`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            application_id: applicationUuid,
                            signer_type: type,
                            signature_data: signatureData,
                            device_info: 'Test Device'
                        })
                    });

                    if (signResponse.ok) {
                        log(`${type} ç­¾åæ·»åŠ æˆåŠŸ`, 'success');
                    }
                }

                // åˆ›å»ºæŠ¥å‘Š
                const reportResponse = await fetch(`${apiUrl}/resignation-reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        application_id: applicationId,
                        work_summary: 'æµ‹è¯•å·¥ä½œæ€»ç»“ï¼šéªŒè¯æ–°æ ¼å¼æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºä¸­æ–‡ç¦»èŒç±»å‹å’Œç­¾åå†…å®¹',
                        unfinished_tasks: 'æµ‹è¯•æœªå®Œæˆäº‹é¡¹ï¼šæ£€æŸ¥æ‰€æœ‰å­—æ®µæ˜¯å¦æ­£ç¡®æ˜¾ç¤º',
                        company_property_returned: true,
                        financial_settlement: true
                    })
                });

                if (!reportResponse.ok) {
                    const error = await reportResponse.json();
                    throw new Error(error.error || 'åˆ›å»ºæŠ¥å‘Šå¤±è´¥');
                }

                const reportData = await reportResponse.json();
                const reportId = reportData.data.id;
                log(`âœ… æµ‹è¯•æŠ¥å‘Šåˆ›å»ºæˆåŠŸï¼ŒID: ${reportId}`, 'success');

                // åœ¨æ–°çª—å£æ‰“å¼€æŠ¥å‘Š
                const viewResponse = await fetch(`${apiUrl}/resignation-reports/${reportId}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (viewResponse.ok) {
                    const viewData = await viewResponse.json();
                    const report = viewData.data;

                    if (report.report_content) {
                        const reportWindow = window.open('', '_blank', 'width=900,height=700');
                        reportWindow.document.write(report.report_content);
                        reportWindow.document.close();
                        log('ğŸ“‹ æ–°æ ¼å¼æŠ¥å‘Šå·²åœ¨æ–°çª—å£æ‰“å¼€ï¼Œè¯·æ£€æŸ¥å†…å®¹', 'success');

                        // éªŒè¯å†…å®¹
                        if (report.report_content.includes('ä¸»åŠ¨ç¦»èŒ')) {
                            log('âœ… ç¦»èŒç±»å‹å·²æ­£ç¡®æ˜¾ç¤ºä¸ºä¸­æ–‡', 'success');
                        } else {
                            log('âŒ ç¦»èŒç±»å‹æœªæ˜¾ç¤ºä¸ºä¸­æ–‡', 'error');
                        }

                        if (report.report_content.includes('<img')) {
                            log('âœ… ç­¾åå›¾ç‰‡å·²åŒ…å«åœ¨æŠ¥å‘Šä¸­', 'success');
                        } else {
                            log('âŒ ç­¾åå›¾ç‰‡æœªæ‰¾åˆ°', 'error');
                        }
                    }
                }

            } catch (error) {
                log('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function () {
            if (!adminToken) {
                log('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç®¡ç†ç³»ç»Ÿ', 'error');
                setTimeout(() => {
                    window.location.href = '/web/login.html';
                }, 2000);
                return;
            }

            log('å·¥å…·å·²å°±ç»ª', 'success');
            log('ç‚¹å‡»"åŠ è½½æŠ¥å‘Šåˆ—è¡¨"å¼€å§‹');
        });
    </script>
</body>

</html>